name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repo into a specific directory
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Checkout the repo into the 'adb-control-gemini' directory
          path: 'adb-control-gemini'

      # 2. Build and package using Docker
      - name: Build and Package with Docker
        # Run commands from the checked-out directory
        working-directory: ./adb-control-gemini
        run: |
          # Update extension version from tag inside the Dockerfile context before building
          VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" gemini-extension.json
          # Build the docker image
          docker build -f Dockerfile -t adb-release-build .
          
          # Use the container to create the tarball
          docker run --name adb-release-container adb-release-build \
            tar -C /extension -cvzf /tmp/adb-release.tar.gz --exclude='.git' --exclude='.github' --exclude='Dockerfile' .
          
          # Copy the tarball out of the container
          docker cp adb-release-container:/tmp/adb-release.tar.gz ../adb-release.tar.gz
          docker rm adb-release-container

      # 3. Create GitHub Release and upload asset
      - name: Create GitHub Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --generate-notes \
            --title "Release ${{ github.ref_name }}" \
            --notes "See the changelog for details." \
            ./adb-release.tar.gz # Path to the asset at the root of the workspace